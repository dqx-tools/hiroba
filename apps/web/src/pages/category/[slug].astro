---
import Layout from "../../layouts/Layout.astro";
import { createDb, getNewsItems, type NewsItem } from "@hiroba/db";
import { CATEGORIES, CATEGORY_LABELS, type Category } from "@hiroba/shared";

const { slug } = Astro.params;

if (!slug || !CATEGORIES.includes(slug as Category)) {
	return Astro.redirect("/");
}

const category = slug as Category;
const cursor = Astro.url.searchParams.get("cursor") ?? undefined;

const runtime = Astro.locals.runtime;
const db = createDb(runtime.env.DB);

let items: NewsItem[] = [];
let hasMore = false;
let nextCursor: string | undefined;

try {
	const result = await getNewsItems(db, {
		category,
		limit: 20,
		cursor,
	});
	items = result.items;
	hasMore = result.hasMore;
	nextCursor = result.nextCursor;
} catch {
	// Show empty list on error
}

const categoryLabel = CATEGORY_LABELS[category];
---

<Layout title={categoryLabel}>
	<h1>{categoryLabel}</h1>

	{items.length > 0 ? (
		<ul class="news-list">
			{items.map((item) => (
				<li>
					<a href={`/news/${item.id}`}>
						<span class="title">{item.titleJa}</span>
						<time datetime={new Date(item.publishedAt * 1000).toISOString()}>
							{new Date(item.publishedAt * 1000).toLocaleDateString("en-US", {
								year: "numeric",
								month: "short",
								day: "numeric",
							})}
						</time>
					</a>
				</li>
			))}
		</ul>
	) : (
		<p class="no-items">No items available</p>
	)}

	<div class="pagination">
		{cursor && (
			<a href={`/category/${category}`} class="prev">← Newest</a>
		)}
		{hasMore && nextCursor && (
			<a href={`/category/${category}?cursor=${nextCursor}`} class="next">
				Older →
			</a>
		)}
	</div>

	<nav class="back-link">
		<a href="/">← Back to home</a>
	</nav>
</Layout>

<style>
	h1 {
		margin-bottom: 1rem;
	}

	.no-items {
		color: var(--color-muted);
		font-style: italic;
	}

	.pagination {
		display: flex;
		justify-content: space-between;
		margin-top: 1.5rem;
		padding-top: 1rem;
		border-top: 1px solid #eee;
	}

	.pagination a {
		padding: 0.5rem 1rem;
		background: #f5f5f5;
		border-radius: 4px;
		text-decoration: none;
	}

	.pagination a:hover {
		background: #eee;
	}

	.back-link {
		margin-top: 2rem;
	}
</style>
