---
import Layout from "../layouts/Layout.astro";
import { getNewsList } from "../lib/api";
import { CATEGORIES, CATEGORY_LABELS, type Category } from "@hiroba/shared";

const newsByCategory = await Promise.all(
	CATEGORIES.map(async (category) => {
		try {
			const { items } = await getNewsList({ category, limit: 5 });
			return { category, items };
		} catch {
			return { category, items: [] };
		}
	})
);
---

<Layout title="Latest News">
	<h1>DQX News</h1>
	<p class="subtitle">Dragon Quest X news translated to English</p>

	{newsByCategory.map(({ category, items }) => (
		<section class="category-section">
			<h2>
				<a href={`/category/${category}`}>{CATEGORY_LABELS[category as Category]}</a>
			</h2>
			{items.length > 0 ? (
				<ul class="news-list">
					{items.map((item) => (
						<li>
							<a href={`/news/${item.id}`}>
								<span class="title">{item.titleJa}</span>
								<time datetime={new Date(item.publishedAt * 1000).toISOString()}>
									{new Date(item.publishedAt * 1000).toLocaleDateString("en-US", {
										year: "numeric",
										month: "short",
										day: "numeric",
									})}
								</time>
							</a>
						</li>
					))}
				</ul>
			) : (
				<p class="no-items">No items available</p>
			)}
			<a href={`/category/${category}`} class="view-all">View all {CATEGORY_LABELS[category as Category]} â†’</a>
		</section>
	))}
</Layout>

<style>
	h1 {
		margin-bottom: 0.25rem;
	}

	.subtitle {
		color: var(--color-muted);
		margin-bottom: 2rem;
	}

	.category-section {
		margin-bottom: 2rem;
	}

	.category-section h2 {
		margin-bottom: 0.5rem;
	}

	.category-section h2 a {
		text-decoration: none;
	}

	.category-section h2 a:hover {
		text-decoration: underline;
	}

	.no-items {
		color: var(--color-muted);
		font-style: italic;
	}

	.view-all {
		display: inline-block;
		margin-top: 0.5rem;
		font-size: 0.9rem;
	}
</style>
