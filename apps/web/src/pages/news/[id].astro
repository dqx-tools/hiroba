---
import Layout from "../../layouts/Layout.astro";
import { createDb, getNewsItem, getOrCreateTranslation } from "@hiroba/db";
import { getNewsBodyWithFetch } from "@hiroba/scraper";
import { CATEGORY_LABELS, type Category } from "@hiroba/shared";

const { id } = Astro.params;

if (!id) {
	return Astro.redirect("/");
}

const runtime = Astro.locals.runtime;
const db = createDb(runtime.env.DB);

// Get the news item
const item = await getNewsItem(db, id);
if (!item) {
	return new Response("Not found", { status: 404 });
}

// Fetch body if needed
if (item.contentJa === null) {
	try {
		const body = await getNewsBodyWithFetch(db, id);
		if (body) {
			item.contentJa = body.contentJa;
		}
	} catch (error) {
		return new Response(`Failed to fetch content: ${error}`, { status: 500 });
	}
}

if (!item.contentJa) {
	return new Response("Content not available yet", { status: 500 });
}

// Get or create translation
let translation;
try {
	translation = await getOrCreateTranslation(
		db,
		id,
		"news",
		"en",
		item.titleJa,
		item.contentJa,
		item.publishedAt,
		runtime.env.OPENAI_API_KEY,
	);
} catch (error) {
	return new Response(`Translation failed: ${error}`, { status: 500 });
}
const title = translation?.title || item.titleJa;
const content = translation?.content || item.contentJa || "Content not available";
const categoryLabel = CATEGORY_LABELS[item.category as Category] || item.category;
---

<Layout title={title}>
	<article>
		<header>
			<div class="meta">
				<a href={`/category/${item.category}`} class="category">{categoryLabel}</a>
				<time datetime={new Date(item.publishedAt * 1000).toISOString()}>
					{new Date(item.publishedAt * 1000).toLocaleDateString("en-US", {
						year: "numeric",
						month: "long",
						day: "numeric",
					})}
				</time>
			</div>
			<h1>{title}</h1>
		</header>

		<div class="content" set:html={content} />

		{translation && (
			<footer class="translation-info">
				<p>
					Translated on {new Date(translation.translatedAt * 1000).toLocaleDateString("en-US", {
						year: "numeric",
						month: "long",
						day: "numeric",
					})}
				</p>
				<details>
					<summary>View original Japanese</summary>
					<div class="original">
						<h2>{item.titleJa}</h2>
						{item.contentJa && (
							<div class="content" set:html={item.contentJa} />
						)}
					</div>
				</details>
			</footer>
		)}

		<nav class="back-link">
			<a href="/">‚Üê Back to home</a>
		</nav>
	</article>
</Layout>

<style>
	article {
		max-width: 100%;
	}

	header {
		margin-bottom: 1.5rem;
	}

	.meta {
		display: flex;
		align-items: center;
		gap: 1rem;
		margin-bottom: 0.5rem;
		color: var(--color-muted);
		font-size: 0.9rem;
	}

	.category {
		text-transform: uppercase;
		font-size: 0.8rem;
		background: #eee;
		padding: 0.2rem 0.5rem;
		border-radius: 3px;
		text-decoration: none;
		color: var(--color-text);
	}

	.category:hover {
		background: #ddd;
	}

	h1 {
		font-size: 1.75rem;
		line-height: 1.3;
	}

	.content {
		line-height: 1.8;
		margin-bottom: 2rem;
		white-space: pre-wrap;
	}

	.translation-info {
		margin-top: 2rem;
		padding-top: 1rem;
		border-top: 1px solid #eee;
		color: var(--color-muted);
		font-size: 0.9rem;
	}

	details {
		margin-top: 1rem;
	}

	summary {
		cursor: pointer;
		color: var(--color-link);
	}

	.original {
		margin-top: 1rem;
		padding: 1rem;
		background: #f5f5f5;
		border-radius: 4px;
	}

	.original h2 {
		font-size: 1.25rem;
		margin-bottom: 1rem;
	}

	.back-link {
		margin-top: 2rem;
	}
</style>
